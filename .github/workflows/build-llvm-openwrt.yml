name: OpenWrt GCC Builder

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/shuangqiao999/openwrt
  REPO_BRANCH: 24.10
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: x86_64_mini.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  UPLOAD_GOFILE: false
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        
        # æ›´æ–°åŒ…åˆ—è¡¨
        sudo apt-get update -y
        
        # å®‰è£…æž„å»ºä¾èµ–ï¼ˆåŒ…å«GCCå·¥å…·é“¾ï¼‰
        sudo apt-get install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext \
          gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 \
          libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev \
          libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
          libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch \
          pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils \
          rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
          vim wget xmlto xxd zlib1g-dev gcc g++ make tree
        
        # æ¸…ç†åŒ…ç¼“å­˜
        sudo apt-get autoremove -y
        sudo apt-get clean
        
        # è®¾ç½®æ—¶åŒº
        sudo timedatectl set-timezone "$TZ"
        
        # åˆ›å»ºå·¥ä½œç›®å½•å¹¶è®¾ç½®æƒé™
        sudo mkdir -p /workdir
        sudo chown -R $USER:$USER /workdir

    - name: Clone source code
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: Load custom feeds
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: Update feeds
      run: cd openwrt && ./scripts/feeds update -a

    - name: Install feeds
      run: cd openwrt && ./scripts/feeds install -a

    - name: Load custom configuration
      run: |
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P2_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH

    # ======================
    # ä¿å­˜ç¼–è¯‘å‰çš„åˆå§‹é…ç½®
    # ======================
    - name: Save initial configuration
      id: save_initial_config
      run: |
        cd openwrt
        # ä¿å­˜åŽŸå§‹é…ç½®
        cp .config .config.initial
        # å°†é…ç½®å¤åˆ¶åˆ°å·¥ä½œç©ºé—´
        cp .config $GITHUB_WORKSPACE/config.initial
        
        echo "ä¿å­˜åˆå§‹é…ç½®å®Œæˆ"
        echo "config_initial=config.initial" >> $GITHUB_OUTPUT

    - name: Download package
      id: package
      run: |
        cd openwrt
        # æ‰§è¡Œdefconfigï¼Œè¿™ä¼šè‡ªåŠ¨è§£æžä¾èµ–
        make defconfig
        # ä¿å­˜defconfigåŽçš„é…ç½®
        cp .config .config.defconfig
        cp .config $GITHUB_WORKSPACE/config.defconfig
        
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    # ======================
    # ä¿å­˜å®Œæ•´çš„ç¼–è¯‘é…ç½®
    # ======================
    - name: Save complete build configuration
      id: save_complete_config
      run: |
        cd openwrt
        echo "====== ä¿å­˜å®Œæ•´ç¼–è¯‘é…ç½® ======"
        
        # 1. ä¿å­˜æœ€ç»ˆçš„.configæ–‡ä»¶
        cp .config $GITHUB_WORKSPACE/config.final
        echo "æœ€ç»ˆé…ç½®å·²ä¿å­˜åˆ° config.final"
        
        # 2. ç”Ÿæˆé…ç½®å·®å¼‚å¯¹æ¯”ï¼ˆä¸Žåˆå§‹é…ç½®å¯¹æ¯”ï¼‰
        if [ -f .config.initial ] && [ -f .config ]; then
          diff -u .config.initial .config > $GITHUB_WORKSPACE/config.diff || true
          echo "é…ç½®å·®å¼‚å·²ä¿å­˜åˆ° config.diff"
        fi
        
        # 3. æå–æ‰€æœ‰æ¿€æ´»çš„é…ç½®é¡¹
        grep '^CONFIG_' .config | sort > $GITHUB_WORKSPACE/config.activated
        echo "æ¿€æ´»çš„é…ç½®é¡¹å·²ä¿å­˜åˆ° config.activated"
        
        # 4. æå–æ‰€æœ‰åŒ…é…ç½®
        grep '^CONFIG_PACKAGE_' .config | sort > $GITHUB_WORKSPACE/config.packages
        echo "åŒ…é…ç½®å·²ä¿å­˜åˆ° config.packages"
        
        # 5. ç”Ÿæˆé…ç½®æ‘˜è¦
        echo "====== é…ç½®æ‘˜è¦ ======" > $GITHUB_WORKSPACE/config.summary
        echo "æ€»é…ç½®é¡¹æ•°: $(grep -c '^CONFIG_' .config)" >> $GITHUB_WORKSPACE/config.summary
        echo "æ¿€æ´»åŒ…æ•°: $(grep -c '^CONFIG_PACKAGE.*=y' .config)" >> $GITHUB_WORKSPACE/config.summary
        echo "æ¨¡å—åŒ–åŒ…æ•°: $(grep -c '^CONFIG_PACKAGE.*=m' .config)" >> $GITHUB_WORKSPACE/config.summary
        echo "ç¦ç”¨åŒ…æ•°: $(grep -c '^# CONFIG_PACKAGE' .config)" >> $GITHUB_WORKSPACE/config.summary
        
        # 6. ä¿å­˜å†…æ ¸é…ç½®ï¼ˆå¦‚æžœæœ‰ï¼‰
        if [ -f .config ]; then
          # æå–å†…æ ¸é…ç½®ç›¸å…³é¡¹
          grep -E '^(CONFIG_|# CONFIG_)' .config | grep -v '^CONFIG_PACKAGE' > $GITHUB_WORKSPACE/config.kernel || true
          echo "å†…æ ¸é…ç½®å·²ä¿å­˜åˆ° config.kernel"
        fi
        
        # 7. åˆ—å‡ºæ‰€æœ‰é…ç½®é˜¶æ®µæ–‡ä»¶
        echo "é…ç½®é˜¶æ®µæ–‡ä»¶:" >> $GITHUB_WORKSPACE/config.summary
        ls -la .config* >> $GITHUB_WORKSPACE/config.summary
        
        echo "ä¿å­˜å®Œæˆ"

    - name: Upload configuration files
      uses: actions/upload-artifact@main
      with:
        name: OpenWrt_Configuration_Files
        path: |
          ${{ github.workspace }}/config.*
          openwrt/.config*
        retention-days: 7

    - name: Compile the firmware
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        
        # ç¼–è¯‘å‰å†æ¬¡ä¿å­˜é…ç½®
        cp .config .config.before_compile
        
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    # ======================
    # ç¼–è¯‘åŽåˆ†æžé…ç½®
    # ======================
    - name: Analyze post-build configuration
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt
        
        # ä¿å­˜ç¼–è¯‘åŽçš„é…ç½®ï¼ˆå¯èƒ½è¢«ä¿®æ”¹è¿‡ï¼‰
        if [ -f .config ]; then
          cp .config $GITHUB_WORKSPACE/config.post_build
          echo "ç¼–è¯‘åŽé…ç½®å·²ä¿å­˜"
        fi
        
        # ç”ŸæˆåŒ…ä¾èµ–æ ‘
        if command -v tree &> /dev/null; then
          find bin -name "*.ipk" -type f | sort > $GITHUB_WORKSPACE/ipk_list.txt
          echo "IPKåŒ…åˆ—è¡¨å·²ç”Ÿæˆ"
        fi
        
        # æ˜¾ç¤ºé…ç½®å˜åŒ–
        echo "====== é…ç½®å˜åŒ–åˆ†æž ======" > $GITHUB_WORKSPACE/config.analysis
        if [ -f .config.initial ] && [ -f .config ]; then
          echo "æ–°å¢žçš„é…ç½®é¡¹:" >> $GITHUB_WORKSPACE/config.analysis
          grep '^CONFIG_' .config | grep -Fvxf <(grep '^CONFIG_' .config.initial) >> $GITHUB_WORKSPACE/config.analysis || true
          
          echo "" >> $GITHUB_WORKSPACE/config.analysis
          echo "ç§»é™¤çš„é…ç½®é¡¹:" >> $GITHUB_WORKSPACE/config.analysis
          grep '^CONFIG_' .config.initial | grep -Fvxf <(grep '^CONFIG_' .config) >> $GITHUB_WORKSPACE/config.analysis || true
        fi

    - name: Check space usage
      if: (!cancelled())
      run: df -hT

    - name: Upload bin directory
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        find . -maxdepth 1 -type f \( -name "*.img" -o -name "*.img.gz" \) ! -name "*combined-efi*" -delete
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    # ======================
    # ä¸Šä¼ æ‰€æœ‰é…ç½®æ–‡ä»¶
    # ======================
    - name: Upload all configuration artifacts
      uses: actions/upload-artifact@main
      if: always()
      with:
        name: Complete_Configurations_${{ env.FILE_DATE }}
        path: |
          ${{ github.workspace }}/config.*
          openwrt/.config*
          openwrt/feeds.conf.default
        retention-days: 30

    - name: Upload firmware directory
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        touch release.txt
        if [ "$UPLOAD_GOFILE" = "true" ]; then
          echo "ðŸ”— GoFile upload is enabled" >> release.txt
        fi
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware to release
      uses: softprops/action-gh-release@master
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 0
        keep_minimum_runs: 2

    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}