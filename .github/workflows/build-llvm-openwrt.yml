name: OpenWrt 完整 LLVM 构建器

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/shuangqiao999/openwrt
  REPO_BRANCH: 24.1
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: x86_64_mini.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  UPLOAD_GOFILE: false
  TZ: Asia/Shanghai
  LLVM_VERSION: 16

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 添加 LLVM 软件源
      run: |
        wget -q https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh ${LLVM_VERSION}
        rm llvm.sh

    - name: 安装完整 LLVM/Clang 工具链
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-${LLVM_VERSION} \
          lld-${LLVM_VERSION} \
          llvm-${LLVM_VERSION} \
          llvm-${LLVM_VERSION}-dev \
          llvm-${LLVM_VERSION}-tools \
          clang-tools-${LLVM_VERSION} \
          libclang-rt-${LLVM_VERSION}-dev \
          libc++-${LLVM_VERSION}-dev \
          libc++abi-${LLVM_VERSION}-dev
        
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-${LLVM_VERSION} 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-${LLVM_VERSION} 100
        sudo update-alternatives --install /usr/bin/llvm-config llvm-config /usr/bin/llvm-config-${LLVM_VERSION} 100
        sudo update-alternatives --install /usr/bin/lld lld /usr/bin/lld-${LLVM_VERSION} 100
        sudo update-alternatives --install /usr/bin/ld.lld ld.lld /usr/bin/ld.lld-${LLVM_VERSION} 100

    - name: 安装构建依赖
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential ccache cmake curl file g++ gawk gettext git libncurses5-dev \
          libssl-dev python3 python3-setuptools rsync unzip wget zlib1g-dev \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison \
          bzip2 cpio device-tree-compiler fastjar flex gperf help2man intltool \
          libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev \
          libmpfr-dev libncursesw5-dev libpython3-dev libreadline-dev libtool \
          lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python2.7 \
          python3-pyelftools qemu-utils scons squashfs-tools subversion swig texinfo \
          uglifyjs upx-ucl vim xmlto xxd
        
        sudo mkdir -p /workdir
        sudo chown -R $USER:$USER /workdir

    - name: 设置 LLVM 环境
      run: |
        echo "CC=clang" >> $GITHUB_ENV
        echo "CXX=clang++" >> $GITHUB_ENV
        echo "LD=lld" >> $GITHUB_ENV
        echo "AR=llvm-ar" >> $GITHUB_ENV
        echo "NM=llvm-nm" >> $GITHUB_ENV
        echo "STRIP=llvm-strip" >> $GITHUB_ENV

    - name: 克隆源代码
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: 加载自定义软件源
      run: |
        if [[ -f $FEEDS_CONF ]]; then
          cp $FEEDS_CONF openwrt/feeds.conf.default
        fi
        if [[ -f $DIY_P1_SH ]]; then
          chmod +x $DIY_P1_SH
          cd openwrt
          bash $GITHUB_WORKSPACE/$DIY_P1_SH
        fi

    - name: 更新软件源
      run: |
        cd openwrt
        ./scripts/feeds update -a

    - name: 安装软件源
      run: |
        cd openwrt
        ./scripts/feeds install -a

    - name: 设置 LLVM 配置
      run: |
        cd openwrt
        # 先创建基础配置
        touch .config
        # 添加优化的LLVM配置
        {
          echo "# 优化的LLVM配置"
          echo "CONFIG_USE_LLVM=y"
          echo "CONFIG_USE_LLD=y" 
          echo "CONFIG_KERNEL_LLVM=y"
          echo "CONFIG_LLVM_VERSION=${LLVM_VERSION}"
          echo "CONFIG_LLVM_TARGET_ARCH=\"x86_64\""
          echo "CONFIG_LLVM_TARGETS=\"X86\""
          echo "CONFIG_USE_LTO_LLVM=y"
          echo "# O3优化配置"
          echo "CONFIG_LLVM_OPTIMIZATION_FLAGS=\"-O3 -pipe -march=x86-64-v2\""
          echo "CONFIG_EXTRA_OPTIMIZATION=\"-O3 -pipe -march=x86-64-v2\""
          echo "CONFIG_TARGET_OPTIMIZATION=\"-O3 -pipe -march=x86-64-v2\""
        } >> .config

    - name: 加载自定义配置
      run: |
        if [[ -d files ]]; then
          cp -r files openwrt/files
        fi
        if [[ -f $CONFIG_FILE ]]; then
          cp $CONFIG_FILE openwrt/.config
        fi
        if [[ -f $DIY_P2_SH ]]; then
          chmod +x $DIY_P2_SH
          cd openwrt
          bash $GITHUB_WORKSPACE/$DIY_P2_SH
        fi

    - name: 验证 LLVM 工具链
      run: |
        cd openwrt
        echo "=== 验证 LLVM 工具链 ==="
        clang --version || echo "clang 未找到"
        ld.lld --version || echo "lld 未找到"
        echo "CC: $CC"
        echo "CXX: $CXX"
        echo "LD: $LD"

    - name: 下载软件包
      run: |
        cd openwrt
        make defconfig
        echo "=== LLVM 配置检查 ==="
        grep "CONFIG.*LLVM" .config || echo "未找到 LLVM 配置"
        echo "=== 优化标志 ==="
        grep "OPTIMIZATION" .config || echo "未找到优化配置"
        make download -j$(nproc)
        # 清理损坏的下载文件
        find dl -size -1024c -delete

    - name: 使用 LLVM 工具链编译
      id: compile
      run: |
        cd openwrt
        echo "开始使用 O3 优化编译，使用 $(nproc) 个线程..."
        
        # 设置编译环境
        export CC=clang
        export CXX=clang++
        export LD=lld
        
        # 尝试编译
        if make -j$(nproc); then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "并行编译失败，尝试单线程编译..."
          if make -j1 V=s; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "编译完全失败"
            exit 1
          fi
        fi
        
        # 获取设备名称
        if grep -q '^CONFIG_TARGET.*DEVICE.*=y' .config; then
          DEVICE_NAME="_$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/')"
          echo "DEVICE_NAME=${DEVICE_NAME}" >> $GITHUB_ENV
        fi
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: 检查构建结果
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt
        echo "=== 构建结果 ==="
        find bin/targets -name "*.img" -o -name "*.gz" -o -name "*.bin" | head -10
        echo "=== 固件大小 ==="
        ls -lh bin/targets/*/*/

    - name: 整理固件文件
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
      id: organize
      run: |
        cd openwrt/bin/targets/*/*
        # 保留主要固件文件，删除不必要的文件
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: 上传固件制品
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success'
      with:
        name: OpenWrt-LLVM-O3-固件${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}
        retention-days: 7

    - name: 创建发布版本
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: llvm-o3-构建-$(date +%Y%m%d-%H%M)
        name: LLVM O3 优化 OpenWrt $(date +%Y-%m-%d)
        body: |
          使用 LLVM/Clang 工具链和 O3 优化编译的 OpenWrt 固件
          
          - 编译器: Clang ${LLVM_VERSION}
          - 链接器: LLD
          - 优化级别: O3 带 x86-64-v2
          - LTO: 已启用
          - 构建日期: $(date)
        files: ${{ env.FIRMWARE }}/*

    - name: 清理工作空间
      if: always()
      run: |
        sudo rm -rf /workdir/openwrt
        rm -rf openwrt || true