name: OpenWrt Full LLVM Builder

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/shuangqiao999/openwrt
  REPO_BRANCH: 24.1
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: x86_64_mini.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  UPLOAD_GOFILE: false
  TZ: Asia/Shanghai
  LLVM_VERSION: 16

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Install Complete LLVM/Clang Toolchain
      run: |
        sudo apt-get update
        # å®‰è£…å®Œæ•´çš„ LLVM å·¥å…·é“¾
        sudo apt-get install -y \
          clang-$LLVM_VERSION \
          lld-$LLVM_VERSION \
          llvm-$LLVM_VERSION \
          llvm-$LLVM_VERSION-runtime \
          llvm-$LLVM_VERSION-dev \
          llvm-$LLVM_VERSION-tools \
          libllvm$LLVM_VERSION \
          clang-tools-$LLVM_VERSION \
          clang-format-$LLVM_VERSION \
          clang-tidy-$LLVM_VERSION \
          libclang-$LLVM_VERSION-dev \
          libclang-rt-$LLVM_VERSION-dev \
          libc++-$LLVM_VERSION-dev \
          libc++abi-$LLVM_VERSION-dev
        
        # åˆ›å»ºç¬¦å·é“¾æŽ¥ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ç‰ˆæœ¬
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-$LLVM_VERSION 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-$LLVM_VERSION 100
        sudo update-alternatives --install /usr/bin/llvm-config llvm-config /usr/bin/llvm-config-$LLVM_VERSION 100
        sudo update-alternatives --install /usr/bin/lld lld /usr/bin/lld-$LLVM_VERSION 100
        sudo update-alternatives --install /usr/bin/ld.lld ld.lld /usr/bin/ld.lld-$LLVM_VERSION 100
        sudo update-alternatives --install /usr/bin/llc llc /usr/bin/llc-$LLVM_VERSION 100
        sudo update-alternatives --install /usr/bin/opt opt /usr/bin/opt-$LLVM_VERSION 100

    - name: Install LLVM-Compatible Build Dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        
        # æ›´æ–°åŒ…åˆ—è¡¨
        sudo apt-get update -y
        
        # å®‰è£…ä¸Ž LLVM å…¼å®¹çš„æž„å»ºä¾èµ–
        sudo apt-get install -y \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext \
          git gperf haveged help2man intltool libelf-dev libfuse-dev libglib2.0-dev \
          libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev \
          libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build \
          p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools \
          qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
          vim wget xmlto xxd zlib1g-dev
        
        # å®‰è£… libc++ å’Œ compiler-rt ç”¨äºŽå®Œæ•´çš„ LLVM å·¥å…·é“¾
        sudo apt-get install -y libc++-$LLVM_VERSION-dev libc++abi-$LLVM_VERSION-dev libclang-rt-$LLVM_VERSION-dev
        
        # æ¸…ç†åŒ…ç¼“å­˜
        sudo apt-get autoremove -y
        sudo apt-get clean
        
        # è®¾ç½®æ—¶åŒº
        sudo timedatectl set-timezone "$TZ"
        
        # åˆ›å»ºå·¥ä½œç›®å½•å¹¶è®¾ç½®æƒé™
        sudo mkdir -p /workdir
        sudo chown -R $USER:$USER /workdir

    - name: Setup LLVM Environment
      run: |
        echo "è®¾ç½®LLVMçŽ¯å¢ƒå˜é‡"
        echo "CC=clang" >> $GITHUB_ENV
        echo "CXX=clang++" >> $GITHUB_ENV
        echo "LD=lld" >> $GITHUB_ENV
        echo "AR=llvm-ar" >> $GITHUB_ENV
        echo "NM=llvm-nm" >> $GITHUB_ENV
        echo "STRIP=llvm-strip" >> $GITHUB_ENV
        echo "OBJCOPY=llvm-objcopy" >> $GITHUB_ENV
        echo "OBJDUMP=llvm-objdump" >> $GITHUB_ENV
        echo "READELF=llvm-readelf" >> $GITHUB_ENV
        echo "RANLIB=llvm-ranlib" >> $GITHUB_ENV
        echo "LLVM_CONFIG=llvm-config" >> $GITHUB_ENV

    - name: Clone source code
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: Load custom feeds
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: Update feeds
      run: cd openwrt && ./scripts/feeds update -a

    - name: Install feeds
      run: cd openwrt && ./scripts/feeds install -a

    - name: Setup Full LLVM Configuration
      run: |
        echo "é…ç½®å®Œæ•´çš„LLVMç¼–è¯‘çŽ¯å¢ƒ"
        cd openwrt
        
        # åŸºç¡€LLVMé…ç½®
        cat > llvm-config.txt << 'EOF'
# å¯ç”¨å®Œæ•´çš„LLVMå·¥å…·é“¾
CONFIG_USE_LLVM=y
CONFIG_LLVM=y
CONFIG_USE_LLD=y
CONFIG_KERNEL_LLVM=y

# LLVM ç‰ˆæœ¬å’Œä¼˜åŒ–
CONFIG_LLVM_VERSION="$LLVM_VERSION"
CONFIG_LLVM_OPTIMIZATION_FLAGS="-O2 -pipe"

# ä½¿ç”¨LLVMçš„binutilsæ›¿ä»£GNU binutils
CONFIG_USE_LLVM_BINUTILS=y

# å†…æ ¸LLVMé…ç½®
CONFIG_KERNEL_LLVM_CFLAGS=""
CONFIG_KERNEL_LLVM_LDFLAGS=""

# ç”¨æˆ·ç©ºé—´LLVMé…ç½®
CONFIG_EXTRA_OPTIMIZATION="-O2 -pipe"
CONFIG_EXTRA_TARGET_ARCH=""
CONFIG_TARGET_OPTIMIZATION="-O2 -pipe"

# ç¦ç”¨GCCç‰¹å®šåŠŸèƒ½
# CONFIG_GCC_USE_VERSION_11 is not set
# CONFIG_GCC_USE_VERSION_12 is not set

# ä½¿ç”¨libc++æ›¿ä»£libstdc++
# CONFIG_USE_LIBCXX=y

# å¯ç”¨LLVM LTOï¼ˆé“¾æŽ¥æ—¶ä¼˜åŒ–ï¼‰
# CONFIG_USE_LTO_LLVM=y

# è®¾ç½®LLVMç›®æ ‡æž¶æž„
CONFIG_LLVM_TARGET_ARCH="x86_64"
CONFIG_LLVM_TARGETS="AArch64;ARM;Mips;PowerPC;RISCV;WebAssembly;X86"
EOF

        # åº”ç”¨LLVMé…ç½®
        cat llvm-config.txt >> .config

    - name: Load custom configuration
      run: |
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P2_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: Verify LLVM Toolchain
      run: |
        cd openwrt
        echo "=== éªŒè¯LLVMå·¥å…·é“¾ ==="
        clang --version
        ld.lld --version
        llvm-config --version
        echo "=== å½“å‰çŽ¯å¢ƒå˜é‡ ==="
        echo "CC=$CC"
        echo "CXX=$CXX"
        echo "LD=$LD"

    - name: Download package
      id: package
      run: |
        cd openwrt
        make defconfig
        # æ˜¾ç¤ºLLVMç›¸å…³é…ç½®
        echo "=== LLVMç›¸å…³é…ç½® ==="
        grep "CONFIG.*LLVM" .config || echo "æœªæ‰¾åˆ°LLVMé…ç½®"
        
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile with LLVM Toolchain
      id: compile
      env:
        # è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒä½¿ç”¨LLVM
        CC: clang
        CXX: clang++
        LD: ld.lld
        AR: llvm-ar
        NM: llvm-nm
        STRIP: llvm-strip
        OBJCOPY: llvm-objcopy
        RANLIB: llvm-ranlib
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile with LLVM"
        
        # å°è¯•ç¼–è¯‘ï¼Œå¦‚æžœå¤±è´¥åˆ™æ˜¾ç¤ºè¯¦ç»†é”™è¯¯
        if ! make -j$(nproc) V=sc 2>&1 | tee build.log; then
          echo "ç¬¬ä¸€æ¬¡ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
          if ! make -j1 V=s 2>&1 | tee build-single.log; then
            echo "ç¼–è¯‘å¤±è´¥ï¼Œæ£€æŸ¥é”™è¯¯..."
            # æ˜¾ç¤ºä¸ŽLLVMç›¸å…³çš„é”™è¯¯
            grep -i "error\|warning" build.log | grep -i "llvm\|clang\|lld" | head -20
            exit 1
          fi
        fi
        
        echo "status=success" >> $GITHUB_OUTPUT
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: Check LLVM Usage in Build
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt
        echo "=== æ£€æŸ¥LLVMä½¿ç”¨æƒ…å†µ ==="
        # æ£€æŸ¥ç¼–è¯‘è¿‡ç¨‹ä¸­ä½¿ç”¨çš„å·¥å…·é“¾
        find staging_dir/host/bin -name "*clang*" -o -name "*llvm*" | head -10
        echo "=== å†…æ ¸ç¼–è¯‘ä¿¡æ¯ ==="
        if [ -f build.log ]; then
          grep -i "clang\|llvm" build.log | head -10
        fi

    - name: Check space usage
      if: (!cancelled())
      run: df -hT

    - name: Upload bin directory
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_LLVM_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        find . -maxdepth 1 -type f \( -name "*.img" -o -name "*.img.gz" \) ! -name "*combined-efi*" -delete
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware directory
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_LLVM_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=llvm-$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        cat > release.txt << 'EOF'
This firmware is compiled with full LLVM/Clang toolchain:

- Compiler: Clang
- Linker: LLD
- Binutils: LLVM binutils
- Kernel: Compiled with Clang

LLVM Version: ${{ env.LLVM_VERSION }}
Build Date: $(date)
EOF
        if [ "$UPLOAD_GOFILE" = "true" ]; then
          echo "ðŸ”— GoFile upload is enabled" >> release.txt
        fi
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware to release
      uses: softprops/action-gh-release@master
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 0
        keep_minimum_runs: 2

    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}