# ======================
# 基础架构与固件配置
# ======================
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_GENERIC=y
CONFIG_TARGET_KERNEL_PARTSIZE=32
CONFIG_TARGET_ROOTFS_PARTSIZE=944
CONFIG_GRUB_EFI_IMAGES=y
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y

# ======================
# 工具链与编译优化
# ======================
CONFIG_KERNEL_CLANG_LLVM=y
CONFIG_LLVM_TARGET_ARCH="x86-64-v2"
CONFIG_USE_LLD=y
CONFIG_LTO_CLANG_THIN=y
CONFIG_KERNEL_LTO=y
CONFIG_KERNEL_OPTIMIZE_O3=y
CONFIG_OPTIMIZE_INLINING=y
CONFIG_ZLIB_OPTIMIZE_SPEED=y
CONFIG_LLVM_DISTRIBUTION_COMPONENTS="clang;lld;llvm-objcopy;llvm-objdump;llvm-ar;llvm-nm"

# ======================
# 安全增强特性
# ======================
CONFIG_CFI_CLANG=y
CONFIG_CFI_CLANG_SHADOW=y
CONFIG_STRICT_KERNEL_RWX=y
CONFIG_HARDENED_USERCOPY=y
CONFIG_INIT_STACK_ALL_ZERO=y
CONFIG_STACKPROTECTOR_STRONG=y
CONFIG_RANDUMIZE_KSTACK_OFFSET=y
CONFIG_STATIC_USERMODEHELPER=y
CONFIG_ZERO_CALL_USED_REGS=y
CONFIG_HAVE_ARCH_JUMP_LABEL_RELATIVE=y
CONFIG_HAVE_ARCH_WITHIN_STACK_FRAMES=y
CONFIG_RANDOMIZE_BASE=y

# ======================
# 硬件特定优化 (Intel J4125)
# ======================
CONFIG_PREEMPT=y
CONFIG_PREEMPT_DYNAMIC=y
CONFIG_HIGH_RES_TIMERS=y
CONFIG_SCHED_HRTICK=y
CONFIG_RCU_BOOST=y
CONFIG_SOFTIRQ_ON_OWN_STACK=y
CONFIG_MIGRATION=y
CONFIG_RCU_NOCB_CPU=y
CONFIG_HZ=1000
CONFIG_INTEL_EPB=y
CONFIG_INTEL_PSTATE=y
CONFIG_INTEL_PSTATE_HWP=y
CONFIG_CPU_FREQ_DEFAULT_GOV_PERFORMANCE=y
CONFIG_CPU_FREQ_GOV_PERFORMANCE=y
CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
CONFIG_CPU_FREQ_GOV_ONDEMAND=y
CONFIG_ACPI_CPPC_CPUFREQ=y
CONFIG_ACPI_CPPC_LIB=y
CONFIG_INTEL_TCC=y
CONFIG_CRYPTO_AES_NI_INTEL=y
CONFIG_INTEL_IDLE=y

# ======================
# 内存管理优化 (8GB专用)
# ======================
CONFIG_TRANSPARENT_HUGEPAGE_MADVISE=y
CONFIG_LRU_GEN=y
CONFIG_LRU_GEN_ENABLED=y
CONFIG_LRU_GEN_WALKS_MMU=y
CONFIG_COMPACTION=y
CONFIG_SLUB=y
CONFIG_SLUB_CPU_PARTIAL=y
CONFIG_SLUB_FREELIST_RANDOM=y
CONFIG_SLUB_FREELIST_HARDENED=y
CONFIG_PAGE_POOL=y

# ======================
# 网络协议栈优化
# ======================
CONFIG_TCP_AO=y
CONFIG_TCP_MD5SIG=y
CONFIG_TCP_NO_TSQ=y
CONFIG_NET_FLOW_LIMIT=y
CONFIG_TCP_CONG_BBR3=y
CONFIG_TCP_CONG_ADVANCED=y
CONFIG_TCP_ZERO_COPY_RECEIVE=y
CONFIG_IP_ROUTE_MULTIPATH=y
CONFIG_IPV6_ROUTER_PREF=y
CONFIG_IP_MULTIPLE_TABLES=y
CONFIG_NET_DEVLINK=y
CONFIG_NET_SCH_DEFAULT=y
CONFIG_DEFAULT_FQ_CODEL=y
CONFIG_NET_SCH_MQPRIO=y
CONFIG_NET_EMATCH=y
CONFIG_NET_ACT_MIRRED=y
CONFIG_IP_TUNNEL=y
CONFIG_NET_SCH_TAPRIO=y
CONFIG_NET_SCH_MULTIQ=y
CONFIG_NET_SCH_PIE=y
CONFIG_NET_SCH_FQ_PIE=y
CONFIG_NET_NS=y
CONFIG_NET_NS_DELAYED=y

# ======================
# Netfilter与NAT加速配置（全锥形NAT+流量卸载相关）
# ======================
CONFIG_NF_NAT_FULLCONE=y
CONFIG_NETFILTER=y
CONFIG_NETFILTER_ADVANCED=y
CONFIG_NF_CONNTRACK=y
CONFIG_NF_CONNTRACK_EVENTS=y
CONFIG_NF_CONNTRACK_IPV4=y
CONFIG_NF_CONNTRACK_IPV6=y
CONFIG_NF_DEFRAG_IPV4=y
CONFIG_NF_DEFRAG_IPV6=y
CONFIG_NF_NAT=y
CONFIG_NF_NAT_IPV4=y
CONFIG_NF_NAT_IPV6=y
CONFIG_NF_NAT_MASQUERADE_IPV4=y
CONFIG_NF_NAT_MASQUERADE_IPV6=y
CONFIG_NF_TABLES=y
CONFIG_NF_TABLES_INET=y
CONFIG_NF_TABLES_IPV4=y
CONFIG_NF_TABLES_IPV6=y
CONFIG_NF_TABLES_NETDEV=y
CONFIG_NF_TABLES_BRIDGE=y
CONFIG_NETFILTER_FLOW_OFFLOAD=y
CONFIG_NETFILTER_XT_TARGET_FLOWOFFLOAD=y
CONFIG_NETFILTER_XT_MATCH_CONNTRACK=y
CONFIG_NETFILTER_XT_MATCH_STATE=y

# ======================
# 网卡驱动优化 (Intel I226)
# ======================
CONFIG_IGC_DCA=y
CONFIG_IGC=y
CONFIG_IGC_HWMON=y
CONFIG_IGC_DIM=y
CONFIG_IGC_VLAN_STRIPPING=y
CONFIG_IGC_RX_NAPI=y
CONFIG_IGC_TX_NAPI=y
CONFIG_IGC_GSO=y
CONFIG_IGC_GRO=y
CONFIG_IGC_RX_COPYBREAK=1024
CONFIG_IGC_RX_NAPI_WEIGHT=256
CONFIG_IGC_RSS=4
CONFIG_IGC_TSO=y
CONFIG_IGC_QUEUES=4

# ======================
# 中断与队列优化
# ======================
CONFIG_XPS=y
CONFIG_XPS_DEFAULT_QUEUES=4
CONFIG_RPS=y
CONFIG_RFS_ACCEL=y
CONFIG_PCI_MSI=y
CONFIG_IRQ_AFFINITY_HINT=y
CONFIG_PCI_MSI_IRQ_DOMAIN=y
CONFIG_GENERIC_IRQ_IPI=y
CONFIG_IRQ_TIME_ACCOUNTING=y
CONFIG_IRQ_DOMAIN_HIERARCHY=y
CONFIG_GENERIC_IRQ_EFFECTIVE_AFF_MASK=y

# ======================
# BPF相关配置 (新增部分)
# ======================
#
# eBPF 和 BPF 内核配置
#
# 核心 BPF 设置
#
CONFIG_BPF=y                  # 启用 BPF 子系统
CONFIG_BPF_SYSCALL=y          # 启用 bpf() 系统调用
CONFIG_BPF_JIT=y              # 启用 BPF 即时编译器
CONFIG_BPF_JIT_ALWAYS_ON=y    # 始终使用 JIT 编译 BPF（安全/性能优化）
CONFIG_HAVE_EBPF_JIT=y        # 架构支持 eBPF JIT

#
# BTF (BPF 类型格式) - CO-RE (一次编译，到处运行) 必需功能
#
CONFIG_DEBUG_INFO_BTF=y       # 为内核和模块生成 BTF 类型信息

#
# 可观测性与追踪
#
CONFIG_BPF_EVENTS=y           # 允许 BPF 程序附加到事件
CONFIG_KPROBES=y              # 启用内核探针 (kprobes)
CONFIG_UPROBES=y              # 启用用户空间探针 (uprobes)
CONFIG_TRACEPOINTS=y          # 启用追踪点基础设施
CONFIG_FTRACE=y               # 启用函数追踪基础设施
CONFIG_FUNCTION_TRACER=y      # 启用函数追踪
CONFIG_FPROBE=y               # 启用 fprobe (函数入口/出口探针)
CONFIG_FTRACE_SYSCALLS=y      # 启用系统调用追踪
CONFIG_BPF_KPROBE_OVERRIDE=y  # 允许 BPF 覆盖 kprobe 返回值

#
# 网络功能
#
CONFIG_NET_CLS_BPF=y          # 基于 BPF 的流量分类器
CONFIG_NET_ACT_BPF=y          # 基于 BPF 的流量动作
CONFIG_NET_SCH_INGRESS=y      # 用于流量控制的入口队列规则
CONFIG_NET_CLS_FLOWER=y       # Flower 流量分类器
CONFIG_NET_ACT_POLICE=y       # 流量监管动作
CONFIG_NET_ACT_GACT=y         # 通用流量动作
CONFIG_NET_ACT_MIRRED=y       # 流量镜像/重定向动作
CONFIG_NET_ACT_SKBEDIT=y      # SKB 编辑动作
CONFIG_LWTUNNEL_BPF=y         # 基于 BPF 的轻量级隧道
CONFIG_XDP_SOCKETS=y          # 用于快速数据包处理的 XDP 套接字
CONFIG_XDP_SOCKETS_DIAG=y     # XDP 套接字诊断功能
CONFIG_NET_XDP=y              # 网络核心中的 XDP 支持

#
# 控制组 (Cgroups)
#
CONFIG_CGROUP_BPF=y           # 为控制组提供 BPF 支持

#
# 安全性
#
CONFIG_BPF_UNPRIV_DEFAULT_OFF=y # 默认禁用非特权 BPF（安全加固）
# CONFIG_BPF_LSM=y             # 可选：实验性 BPF Linux 安全模块支持

#
# 其他功能
#
CONFIG_BPF_STREAM_PARSER=y    # 用于套接字数据的 BPF 流解析器
CONFIG_BPF_LIRC_MODE2=y       # 对 LIRC 模式2设备的 BPF 支持

# ======================
# 内核模块与流表加速 (适配nftables/firewall4)
# ======================
CONFIG_PACKAGE_kmod-sched-core=y
CONFIG_PACKAGE_kmod-sched-bpf=y
CONFIG_PACKAGE_kmod-sched-fq=y
CONFIG_PACKAGE_kmod-sched-cake=y
CONFIG_PACKAGE_kmod-sched-connmark=y
CONFIG_PACKAGE_kmod-ifb=y
CONFIG_PACKAGE_kmod-bonding=y
CONFIG_PACKAGE_kmod-tcp-bbr=y

# NFTables核心模块
CONFIG_PACKAGE_kmod-nft-core=y
CONFIG_PACKAGE_kmod-nft-nat=y
CONFIG_PACKAGE_kmod-nft-netdev=y
CONFIG_PACKAGE_kmod-nft-bridge=y
CONFIG_PACKAGE_kmod-nft-offload=y
CONFIG_PACKAGE_kmod-nft-socket=y
CONFIG_PACKAGE_kmod-nft-fullcone=y
CONFIG_PACKAGE_kmod-nf-flow=y
CONFIG_PACKAGE_kmod-nf-conntrack-netlink=y
CONFIG_PACKAGE_kmod-nf-reject=y
CONFIG_PACKAGE_kmod-nft-queue=y
CONFIG_PACKAGE_kmod-nft-log=y
CONFIG_PACKAGE_kmod-nft-limit=y

# Netfilter核心依赖
CONFIG_PACKAGE_kmod-nf-conntrack=y
CONFIG_PACKAGE_kmod-nf-conntrack6=y
CONFIG_PACKAGE_kmod-nf-nat=y
CONFIG_PACKAGE_kmod-nf-nat6=y

# 加密与文件系统模块
CONFIG_PACKAGE_kmod-crypto-sha256=y

# ======================
# 用户态工具与库 (nftables专用)
# ======================
CONFIG_PACKAGE_nftables-json=y
CONFIG_PACKAGE_libnftnl=y
CONFIG_PACKAGE_libnetfilter-conntrack=y
CONFIG_PACKAGE_libnetfilter-queue=y
CONFIG_PACKAGE_libnetfilter-log=y
CONFIG_PACKAGE_jansson=y

# 基础工具
CONFIG_PACKAGE_libtirpc=y
CONFIG_PACKAGE_ip-full=y
CONFIG_PACKAGE_htop=y
CONFIG_PACKAGE_iperf3=y
CONFIG_PACKAGE_ethtool=y
CONFIG_PACKAGE_openssl-util=y
CONFIG_PACKAGE_irqbalance=y
CONFIG_PACKAGE_ipv6helper=y

# ======================
# LuCI应用配置
# ======================
CONFIG_PACKAGE_luci-app-arpbind=y
CONFIG_PACKAGE_luci-app-oaf=y
CONFIG_PACKAGE_luci-app-filemanager=y
CONFIG_PACKAGE_luci-app-irqbalance=y
CONFIG_PACKAGE_luci-app-firewall=y

# ======================
# IPv6支持
# ======================
CONFIG_IPV6_ROUTE_INFO=y
CONFIG_IPV6_MULTIPLE_TABLES=y
CONFIG_IPV6_OPTIMISTIC_DAD=y
CONFIG_IPV6_SUBTREES=y